!Autor: Robson Vaamonde
!Procedimentos em TI: http://procedimentosemti.com.br
!Bora para Prática: http://boraparapratica.com.br
!Robson Vaamonde: http://vaamonde.com.br
!Facebook Procedimentos em TI: https://www.facebook.com/ProcedimentosEmTi
!Facebook Bora para Prática: https://www.facebook.com/BoraParaPratica
!Instagram Procedimentos em TI: https://www.instagram.com/procedimentoem
!YouTUBE Bora Para Prática: https://www.youtube.com/boraparapratica
!Data de criação: 31/05/2020
!Data de atualização: 31/05/2020
!Versão: 0.01
!Testado e homologado no Cisco Packet Tracer 7.3 e GNS3 2.2.7

!DHCPv6 Stateful (com estado): O DHCPv6 Stateful é muito parecido com o funcionamento do Servidor DHCPv4. 
!O servidor DHCPv6 Stateful atribui endereços IPv6 a todos os hosts com o DHCPv6 Client configurado, mantendo
!o controle de qual endereço IPv6 foi atribuído ao host. O servidor também pode oferecer outros parâmetros
!de rede, como servidores DNS, um nome de Domínio ou qualquer outra opção fornecida por um Servidor DHCPv6.

!O DHCPv6 Stateful trabalha com o Protocolo UDP (User Datagram Protocol) na Porta Padrão: 547

!OBSERVAÇÃO IMPORTANTE: A CONFIGURAÇÃO DO DHCPv6 STATEFUL EM ROTEADORES NÃO É RECOMENDADA PELA CISCO, NEM TODOS 
!OS ROUTER E SWITCH LAYER 3 TEM ESSA FUNÇÃO, ESSE SERVIÇO É INDICADO PARA SER CONFIGURADO EM SERVIDORES GNU/LINUX
!OU MICROSOFT WINDOWS SERVER.

!OBSERVAÇÃO IMPORTANTE: NO CISCO PACKET TRACER VERSÃO 7.3 AS CONFIGURAÇÕES DO DHCPv6 STATEFUL SÃO LIMITADAS, É
!RECOMENDADO UTILIZAR AS VERSÕES DO IOS 15.x

!ACRÉSCIMO - IMPORTANTE: NO CISCO PACKET TRACER VERSÃO 7.3 O SUPORTE AO PROTOCOLO IPv6 NO SWITCH LAYER 2 2960 SÓ
!FUNCIONA CORRETAMENTE NA VERSÃO 15.x DO IOS, RECOMENDO FAZER O UPGRADE DO IOS ANTES DA CONFIGURAÇÃO, MESMO EXECUTANDO
!A ATUALIZAÇÃO, FAZENDO A CONFIGURAÇÃO DO SDM PREFER, O PING DO DESKTOP PARA OS SWITCHES LAYER 2 2960 NÃO É CONCLUÍDO
!COM SUCESSO (Request timed out.), O PING DO SWITCH LAYER 2 PARA O DESKTOP TEM A MESMA FALHA (% Unrecognized host or 
!address, or protocol not running.) - ATÉ O MOMENTO DA GRAVAÇÃO DESSE VÍDEO: 12/06/2020 A FALHA PERSISTE, ESTANDO 
!RELACIONADA APARENTEMENTE AO SIMULADOR (executando testes é analisando comentários no Fórum da Cisco), NOS EQUIPAMENTOS
!REAIS ESSA FALHA NÃO ACONTECE.

!ADENDO IMPORTANTE: TESTE FEITO NO DIA 16/06/2020, QUANDO É INICIADO A SIMULAÇÃO DO AMBIENTE, OS SWITCHES LAYER 2 2960
!PERDE AS CONFIGURAÇÕES DO SDM E DAS CONFIGURAÇÕES DOS ENDEREÇOS IPv6, SENDO NECESSÁRIO FAZER O RELOAD DO EQUIPAMENTO
!PARA O SDM VOLTAR A FUNCIONAR, MAIS AS CONFIGURAÇÕES DOS ENDEREÇOS IPv6 SÃO PERDIDAS, SENDO NECESSÁRIO REFAZER. DICA:
!RECOMENDO NÃO PERDER TEMPO NESSAS CONFIGURAÇÕES NO CISCO PACKET TRACER 7.3, NA NOVA TOPOLOGIA QUE SERÁ CRIADA VOU UTILIZAR
!O ROUTER DA SÉRIE 4000 E SWITCH MULTILAYER DA SÉRIE 3650 QUE SÃO EQUIPAMENTOS ATUALIZADOS PARA OS NOVOS CENÁRIOS DO CCNAv7

!PRIMEIRA ETAPA: Configuração do Endereço IPv6 Estático do Servidor
!Faixa Link Local: FE80::/10
!Faixa Global Unicast: 2001:abcd:1234:100::/64
!Endereço IPv6 Unicast Global: 2001:abcd:1234:100::1/64
!Endereço IPv6 Link Local: FE80::1
!Endereço IPv6 do Gateway: FE80::100
!Endereço IPv6 do DNS Server: 2001:abcd:1234:3::1

!SEGUNDA ETAPA: Atualização do Rota de Retorno do Router 1941 do DNS do Google
!OBSERVAÇÃO: configurar o Rota Padrão de Retorno totalmente Declarada no Router após a configuração do SLAAC no Router 2911
!OBSERVAÇÃO: igual as configurações do IPv4, na vida real não é configurado a Rota de Retorno, nesse cenário utilizamos
!recursos de Tradução de Endereços IPv6 (NAT).
enable
	configure terminal
		no ipv6 route ::/0 GigabitEthernet0/1 
		ipv6 route ::/0 GigabitEthernet0/1 FE80::201:43FF:FE67:A502
		end
write

!TERCEIRA ETAPA: Configuração do Router 2911
enable
	configure terminal
		ipv6 unicast-routing

		!Configurando o Pool (Escopo) do DHCPv6 Stateful da VLAN 10
		ipv6 dhcp pool stateful_vlan10
			domain-name vaamonde.pti
			dns-server 2001:abcd:1234:3::1

			!Configurando o Prefixo Padrão do Endereço IPv6 no Pool do DHCPv6 Stateful
			!DICA: essa opção configurar o endereço de prefixo padrão que será utilizado na VLAN 10
			!OBSERVAÇÃO: nas configurações da delegação do endereço de prefixo é determinado o tempo de vida (lifetime)
			!do Prefixo e da Preferência dos endereços atribuídos os hosts em segundos
			!IMPORTANTE: para funcionar perfeitamente a opção do DHCPv6 Stateful no Router 2911 é necessário fazer a
			!configuração do Pool Local no Modo EXEC Privilegiado é da configuração da Delegação do Prefixo com os comandos:
			!ipv6 local pool stateful_vlan10 2001:abcd:1234:10::/64 64 | prefix-delegation pool stateful_vlan10 
			!OBSERVAÇÃO IMPORTANTE: com essa configuração feita a Interface não vai manter a configuração do IPv6 Global
			!Unicast, não possibilitando o Roteamente entre as Redes IPv6, por esse motivo não estarei utilizando esses 
			!recursos nesse cenário
			address prefix 2001:abcd:1234:10::/64 lifetime 1800 600
			exit

		!Configurando o Endereço IPv6 da Sub-Interface da VLAN 10
		interface gigabitEthernet0/0.10
			ipv6 enable
			ipv6 address fe80::10 link-local
			ipv6 address 2001:abcd:1234:10::10/64
			ipv6 dhcp server stateful_vlan10

			!OBSERVAÇÃO: nas configurações do DHCPv6 Stateful utilizamos a opção: managed-config-flag que habilita a Flag M, 
			!com essa opção configurada junto com o Pool Local os hosts DHCPv6 vão obter os endereços de Global Unicast corretamente,
			!todas as informações de leasing dos endereços IPv6 ficaram armazenadas no roteador
			!OBSERVAÇÃO IMPORTANTE: nesse cenário, como não está sendo utilizado os recursos do Pool Local e da Delegação, as opções
			!da Flag M não vai funcionar, mais você pode utilizar a opção da Flag O para Auto-Configurar os endereços IPv6 dos hosts 
			!das VLANs
			ipv6 nd other-config-flag
			exit

		ipv6 dhcp pool stateful_vlan20
			domain-name vaamonde.pti
			dns-server 2001:abcd:1234:3::1
			address prefix 2001:abcd:1234:20::/64 lifetime 1800 600
			exit
		interface gigabitEthernet0/0.20
			ipv6 enable
			ipv6 address fe80::20 link-local
			ipv6 address 2001:abcd:1234:20::20/64
			ipv6 dhcp server stateful_vlan20
			ipv6 nd other-config-flag
			exit

		ipv6 dhcp pool stateful_vlan30
			domain-name vaamonde.pti
			dns-server 2001:abcd:1234:3::1
			address prefix 2001:abcd:1234:30::/64 lifetime 1800 600
			exit
		interface gigabitEthernet0/0.30
			ipv6 enable
			ipv6 address fe80::30 link-local
			ipv6 address 2001:abcd:1234:30::30/64
			ipv6 dhcp server stateful_vlan30
			ipv6 nd other-config-flag
			exit		

		ipv6 dhcp pool stateful_vlan40
			domain-name vaamonde.pti
			dns-server 2001:abcd:1234:3::1
			address prefix 2001:abcd:1234:40::/64 lifetime 1800 600
			exit
		interface gigabitEthernet0/0.40
			ipv6 enable
			ipv6 address fe80::40 link-local
			ipv6 address 2001:abcd:1234:40::40/64
			ipv6 dhcp server stateful_vlan40
			ipv6 nd other-config-flag
			exit

		ipv6 dhcp pool stateful_vlan50
			domain-name vaamonde.pti
			dns-server 2001:abcd:1234:3::1
			address prefix 2001:abcd:1234:50::/64 lifetime 1800 600
			exit
		interface gigabitEthernet0/0.50
			ipv6 enable
			ipv6 address fe80::50 link-local
			ipv6 address 2001:abcd:1234:50::50/64
			ipv6 dhcp server stateful_vlan50
			ipv6 nd other-config-flag
			exit

		interface gigabitEthernet0/0.99
			ipv6 enable
			ipv6 address fe80::99 link-local
			ipv6 address 2001:abcd:1234:99::99/64
			exit
			
		interface gigabitEthernet0/0.100
			ipv6 enable
			ipv6 address fe80::100 link-local
			ipv6 address 2001:abcd:1234:100::100/64
			end
write

!QUARTA ETAPA: Configuração do Switch Layer 3 3560-2
enable
	configure terminal

		!OBSERVAÇÃO: no Switch Layer 3, diferente do Switch Layer 2, temos as opções de configuração do SDM
		!default (padrão), routing (roteamento) e vlan (virtual LAN)
		sdm prefer dual-ipv4-and-ipv6 default
		end
write
reload

enable
	configure terminal
		interface vlan 99
			ipv6 address FE80::252 link-local
			ipv6 address 2001:abcd:1234:99::252/64
			end
write

!Visualizando as configurações da memória RAM
show running-config | section interface
show running-config | section ipv6 dhcp

!Visualizando as informações dos endereços IPv6
show ipv6 interface brief
show ipv6 interface gigabitethernet 0/0.10
show ipv6 dhcp pool
show ipv6 dhcp interface
show ipv6 dhcp binding
show ipv6 route
show sdm prefer
show ipv6 interface vlan 99
ping FE80::254
ping 2001:ABCD:1234:8::8
tracert 2001:ABCD:1234:8::8

!Bloco de configuração do DHCPv6 Stateful com Pool Local e Delegação
configure terminal
	ipv6 unicast-routing
	ipv6 dhcp pool stateful_vlan10
		domain-name vaamonde.pti
		dns-server 2001:abcd:1234:3::1
		address prefix 2001:abcd:1234:10::/64 lifetime 1800 600
		prefix-delegation pool stateful_vlan10 
		exit
	interface gigabitEthernet0/0.10
		ipv6 enable
		ipv6 address fe80::10 link-local
		!ipv6 address 2001:abcd:1234:10::254/64
		ipv6 dhcp server stateful_vlan10
		ipv6 nd managed-config-flag
		exit
	ipv6 local pool stateful_vlan10 2001:abcd:1234:10::/64 64
	end
write